# Creating AppArmor Profiles

<figure><img src="../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

* In this lecture, we will learn how to create apparmor profiles. In the previous lecture, we saw a few examples of apparmor profiles.
* &#x20;Now let's see how we can create custom application-specific profiles from scratch. As an example, let us make use of a simple bash script that creates directories under the slash opt file system, and then writes into a file within this directory.
* &#x20;Now, let us see how we can create apparmor profile for this specific script.

<figure><img src="../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

* Instead of manually creating the profile, we can leverage tools provided by apparmor. To do this, let us first install the apparmor-utils package.&#x20;
* For Ubuntu, we can do this by running the command apt-get install apparmor-utils.&#x20;
* Once this package is installed, we will make use of the aa-gen prof command to create a profile for the bash script.

<figure><img src="../.gitbook/assets/image (22).png" alt=""><figcaption></figcaption></figure>

* Now we can run the aa-genprof command followed by the absolute parth to the shell script like this. The aa-genprof command expects that the application, which in this case is the shell script, be run from a different window so that it can scan for the events.&#x20;
* From a separate window, let us run the bash script.

<figure><img src="../.gitbook/assets/image (23).png" alt=""><figcaption></figcaption></figure>

* Once we have run the script, enter S to scan for the system logs for the apparmor events that were generated when we ran the script. This generates a series of questions that we must answer to guide the aa-genprof command in generating the security profile.
* For example, the first event asks if we can provide the script to run the mkdir command and allows us to choose one-off Inherit, Child, Named, IX, Deny, Abort, and Finish.
* To grant access to the shell script to execute mkdir, we can make use of the Inherit option, so enter I.

<figure><img src="../.gitbook/assets/image (24).png" alt=""><figcaption></figcaption></figure>

* Once we type enter apparmor will present you with a similar prompt with the next event. This time we can again grant the execute permission for the key command using the Inherit option.&#x20;
* Notice that sometimes apparmor also provides a severity rating for the event, but severity 10 being the highest.

<figure><img src="../.gitbook/assets/image (25).png" alt=""><figcaption></figcaption></figure>

* The next event asks us to review if the dev/tty can be accessed with read and write permission. This event a severity of nine and also shows the permissions under the field called new mode. Since the script prints to the console, it needs access to the tty interface so this operation can be allowed. This time enter A to this access.

<figure><img src="../.gitbook/assets/image (26).png" alt=""><figcaption></figcaption></figure>

* For the next question, we have been asked if you want to provide read access to the /proc file system. Now, this is not particularly needed by our script, so we can deny it by entering D.

<figure><img src="../.gitbook/assets/image (27).png" alt=""><figcaption></figcaption></figure>

* Do this for all the questions generated by apparmor. Allow ones that are absolutely needed by the script and deny those that are not. Once done, use the S key to save the profile and then press F to finish.

<figure><img src="../.gitbook/assets/image (28).png" alt=""><figcaption></figcaption></figure>

* Our newly generated profile is now running in enforce mode, and this can be validated by running the aa- command again.



<figure><img src="../.gitbook/assets/image (29).png" alt=""><figcaption></figcaption></figure>

* Our new apparmor profile along with the existing ones are stored under the /etc/apparmor.d directory. Here, we can see that the profile is for the shell script called add\_data.sh, which is located under /root, and all the rules that we declared are inside the curly braces.

<figure><img src="../.gitbook/assets/image (30).png" alt=""><figcaption></figcaption></figure>

* While the profile is enforce, let us try to run this script again to make sure that it is working as expected. Let us test this by changing the part where the log file is written to /opt instead of /opt/app/data.
* If you're on the script now it should fill. The message is still printed on the terminal, but the apparmor only allows rights to the directory /opt/app and /opt/app/data, but not directly to /opt. As a result, the T command fills with the permission denied error.

<figure><img src="../.gitbook/assets/image (31).png" alt=""><figcaption></figcaption></figure>

* Before we move on to the next lecture, let us see how to work with existing apparmor profiles. To load a profile run the command apparmor\_parser like this.&#x20;
* If nothing is written, that would mean that the profile was successfully loaded. To disable a profile, run the same command, but with the -r flag, and then create a same line to the profile inside the /etc/apparmor.d/disabled directory like this.
